<!doctype html>
<html lang="en" class="notranslate">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google" content="notranslate" />
  <title>Heliroma â€” IFC 3D Viewer</title>

  <!-- Inline favicon (evita 404 do favicon.ico) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%2306b26e'/%3E%3Cpath d='M20 34l7 7 17-19' fill='none' stroke='white' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">

  <style>
    :root{
      --bg:#071321; --text:#e5eefc; --muted:rgba(229,238,252,.72);
      --accent:#06b26e; --danger:#ef4444; --border:rgba(255,255,255,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.38);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    #app{height:100%; display:grid; grid-template-rows:auto 1fr;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.04); backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:260px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 6px rgba(6,178,110,.12)}
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted); margin-top:2px}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      appearance:none; border:1px solid var(--border); color:var(--text);
      background:rgba(255,255,255,.05);
      padding:9px 11px; border-radius:10px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    button:hover{background:rgba(255,255,255,.08)}
    button.primary{background:rgba(6,178,110,.18); border-color:rgba(6,178,110,.35)}
    button.primary:hover{background:rgba(6,178,110,.24)}
    .pill{font-size:12px;color:var(--muted); border:1px solid var(--border);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.04)}
    #viewer{position:relative; height:100%;}
    canvas{display:block; width:100%; height:100%;}
    input[type="file"]{display:none}
    .toast{
      position:absolute; left:14px; right:14px; bottom:14px;
      display:none; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(8,16,28,.72); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      align-items:flex-start; gap:10px;
    }
    .toast.show{display:flex}
    .toast .badge{width:10px;height:10px;border-radius:999px;margin-top:6px;background:var(--accent)}
    .toast.err .badge{background:var(--danger)}
    .toast .msg{font-size:13px; line-height:1.35}
    .toast .hint{margin-top:3px; font-size:12px; color:var(--muted)}
    .help{
      position:absolute; left:14px; bottom:86px;
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); backdrop-filter: blur(10px);
      max-width:360px;
    }
    .help b{display:block; margin-bottom:6px}
    .help div{font-size:12px;color:var(--muted); line-height:1.35}
  </style>
</head>

<body>
<div id="app">
  <header>
    <div class="brand">
      <span class="dot"></span>
      <div>
        <div class="title">Heliroma â€” IFC 3D Viewer</div>
        <div class="sub">Rotate / Zoom / Pan â€¢ Default model auto-load</div>
      </div>
    </div>

    <div class="right">
      <span id="status" class="pill">Startingâ€¦</span>

      <label>
        <input id="file" type="file" accept=".ifc" />
        <button id="btnLoad" class="primary" type="button">ðŸ“¦ Load IFC</button>
      </label>

      <button id="btnFit" type="button">â¤¢ Fit</button>
      <button id="btnReset" type="button">â†º Reset</button>
      <button id="btnClear" type="button">âœ• Clear</button>
    </div>
  </header>

  <div id="viewer">
    <canvas id="canvas"></canvas>

    <div class="help">
      <b>Controls</b>
      <div>â€¢ Drag = rotate â€¢ Scroll/pinch = zoom â€¢ Right-drag (or 2-finger) = pan</div>
      <div style="margin-top:6px">Default model: <span style="color:var(--text)">Projeto_Objeto3D_Chat.ifc</span></div>
    </div>

    <div id="toast" class="toast">
      <div class="badge"></div>
      <div>
        <div id="toastMsg" class="msg"></div>
        <div id="toastHint" class="hint"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";
  import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js";
  import { IFCLoader } from "https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.126/IFCLoader.js";

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const toastEl = $("toast");
  const toastMsg = $("toastMsg");
  const toastHint = $("toastHint");

  function setStatus(text){ statusEl.textContent = text; }
  function toast(message, hint="", isError=false){
    toastEl.classList.toggle("err", !!isError);
    toastMsg.textContent = message;
    toastHint.textContent = hint;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), isError ? 9000 : 4200);
  }

  const canvas = $("canvas");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setClearColor(0x071321, 1);

  const scene = new THREE.Scene();

  const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 2000);
  camera.position.set(8, 6, 10);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;

  scene.add(new THREE.HemisphereLight(0xffffff, 0x223355, 0.9));
  const dir = new THREE.DirectionalLight(0xffffff, 0.7);
  dir.position.set(10, 20, 10);
  scene.add(dir);

  const grid = new THREE.GridHelper(20, 20, 0x233044, 0x152033);
  grid.material.opacity = 0.35;
  grid.material.transparent = true;
  scene.add(grid);

  const ifcLoader = new IFCLoader();
  ifcLoader.ifcManager.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.57/dist/");

  let model = null;

  function onResize(){
    const w = canvas.clientWidth || canvas.parentElement.clientWidth;
    const h = canvas.clientHeight || canvas.parentElement.clientHeight;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  new ResizeObserver(onResize).observe(document.getElementById("viewer"));
  onResize();

  function fitToObject(object3d){
    const box = new THREE.Box3().setFromObject(object3d);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    const fov = camera.fov * Math.PI / 180;
    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
    cameraZ *= 1.35;

    camera.position.set(center.x + cameraZ, center.y + cameraZ * 0.35, center.z + cameraZ);
    camera.near = Math.max(0.01, maxDim / 1000);
    camera.far  = Math.max(2000, maxDim * 50);
    camera.updateProjectionMatrix();

    controls.target.copy(center);
    controls.update();
  }

  function clearModel(){
    if (model){
      scene.remove(model);
      model = null;
    }
    setStatus("Cleared");
  }

  async function loadFromUrl(url){
    setStatus("Loading IFCâ€¦");
    try{
      const loaded = await ifcLoader.loadAsync(url);
      clearModel();
      model = loaded;
      scene.add(model);
      setStatus("Loaded");
      toast("IFC loaded successfully.", url.replace("./",""));
      fitToObject(model);
    }catch(err){
      console.error(err);
      setStatus("Error");
      toast("Failed to load IFC.", String(err?.message || err), true);
    }
  }

  $("btnLoad").addEventListener("click", ()=> $("file").click());
  $("file").addEventListener("change", async (ev)=>{
    const file = ev.target.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    await loadFromUrl(url);
    URL.revokeObjectURL(url);
    ev.target.value = "";
  });

  $("btnFit").addEventListener("click", ()=> model ? fitToObject(model) : toast("No model loaded."));
  $("btnReset").addEventListener("click", ()=>{
    controls.reset();
    camera.position.set(8, 6, 10);
    controls.update();
    toast("View reset.");
  });
  $("btnClear").addEventListener("click", ()=> { clearModel(); toast("Cleared."); });

  // Auto-load default IFC from repo root (case-sensitive)
  loadFromUrl("./Projeto_Objeto3D_Chat.ifc");

  function animate(){
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
  animate();
</script>
</body>
</html>
